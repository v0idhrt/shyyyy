# PDF Service

## Назначение

Генерация PDF отчётов о изменениях в планировках помещений.

## Технологии

- **Python 3.x**
- **Flask** - веб-фреймворк
- **WeasyPrint** - HTML → PDF конвертация
- **CairoSVG** - SVG → PNG конвертация

## Архитектура

### Модули

- **main.py** - Flask сервер, HTTP handlers
- **svg_comparator.py** - сравнение SVG файлов, обнаружение изменений
- **templates/report.html** - HTML шаблон для PDF документа

### Процесс генерации PDF

1. Получение запроса с file_id и user_id
2. Загрузка оригинального и изменённого SVG файлов
3. Конвертация SVG → PNG (base64) для встраивания в HTML
4. Сравнение SVG файлов:
   - Парсинг XML элементов
   - Классификация по типам (стены, двери, окна, комнаты)
   - Обнаружение добавленных/удалённых элементов
   - Обнаружение изменений позиции, цвета, размера
5. Получение данных пользователя из Auth Service
6. Генерация HTML из шаблона
7. Конвертация HTML → PDF через WeasyPrint
8. Возврат PDF файла

## API

### POST /generate

Генерация PDF отчёта о изменениях планировки.

**Request:**
```json
{
  "file_id": "1",
  "user_id": "demo-user"
}
```

**Response:**
- `200 OK` - PDF файл (`application/pdf`)
- `400 Bad Request` - некорректный запрос
- `404 Not Found` - SVG файлы не найдены
- `500 Internal Server Error` - ошибка генерации

**Пример запроса:**
```bash
curl -X POST http://localhost:3000/api/v1/pdf/generate \
  -H "Content-Type: application/json" \
  -d '{"file_id": "1", "user_id": "demo-user"}' \
  -o report.pdf
```

### GET /health

Health check endpoint.

**Response:**
```json
{
  "status": "ok",
  "service": "pdf-service"
}
```

## Структура PDF документа

### Заголовок
- Дата (текущая, справа сверху)
- Город: Краснодар

### Планировки
- Оригинальная планировка (PNG, слева)
- Вертикальная линия-разделитель
- Изменённая планировка (PNG, справа)

### Описание изменений
Автоматически генерируемый список:
- Добавленные элементы: "Добавлена дверь (Door_01)"
- Удалённые элементы: "Удалена стена (Wall_05)"
- Изменённые элементы: "Окно (Window_02): перемещено, изменён цвет"

### Данные заявителя
- ФИО заявителя
- Номер телефона
- Адрес

## Алгоритмы сравнения

### Классификация элементов

По ID префиксам:
- `Wall_*` - стены
- `Door_*` - двери
- `Window_*` - окна
- `Room_*` - комнаты
- `Balcony_*` - балконы

### Типы изменений

**Добавление/удаление:**
- Сравнение множеств ID элементов

**Изменение позиции:**
- Для `rect`: сравнение атрибутов `x`, `y`
- Для `path`: сравнение атрибута `d`

**Изменение цвета:**
- Сравнение атрибутов `style`, `fill`, `stroke`

**Изменение размера:**
- Для `rect`: сравнение атрибутов `width`, `height`

## Конфигурация

### Переменные окружения

```bash
PORT=3004                                    # Порт сервиса
AUTH_SERVICE_URL=http://localhost:3002       # URL Auth Service
```

### Зависимости

```txt
flask==3.1.0
weasyprint==62.3
requests==2.32.3
cairosvg==2.7.1
```

## Установка и запуск

```bash
# Установка зависимостей
cd cmd/pdf_service
pip install -r requirements.txt

# Запуск сервиса
PORT=3004 AUTH_SERVICE_URL=http://localhost:3002 python main.py
```

## Структура файлов

```
source/
  {user_id}/
    svg/
      {1-5}.svg              # Оригинальные планировки
      edited/
        {1-5}.svg            # Изменённые планировки
```
